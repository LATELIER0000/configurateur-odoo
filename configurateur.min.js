// Configurateur de Prix L'Atelier - Version GitHub Simple et Robuste
(function() {
    'use strict';
    
    // Vérifier que le DOM est prêt
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initConfigurator);
    } else {
        initConfigurator();
    }
    
    function initConfigurator() {
        console.log('🚀 Initialisation du configurateur depuis GitHub...');
        
        // Variables globales
        let data = [], step = 1, selections = {};
        
        // Utilitaires DOM
        const $ = id => document.getElementById(id);
        const $$ = sel => document.querySelectorAll(sel);
        
        // Configuration par défaut
        const CONFIG = Object.assign({
            csvUrl: 'https://raw.githubusercontent.com/LATELIER0000/configurateur-odoo/main/configurateur_data.csv',
            phoneNumber: '+33139510575',
            repairTimes: { 'Écran': '30-45 min', 'Batterie': '20-30 min', 'Châssis': '1-2h' },
            odooConfig: {
                serverUrl: 'https://www.latelier.app',
                loginUrl: 'https://www.latelier.app/web/login',
                appointmentUrl: 'https://www.latelier.app/appointment/'
            }
        }, window.CONFIGURATEUR_CONFIG || {});
        
        // Utilitaires d'affichage
        const showLoading = () => {
            const loading = $('loading');
            const error = $('error');
            const form = $('form');
            
            if (loading) loading.style.display = 'block';
            if (error) error.classList.add('hidden');
            if (form) form.classList.add('hidden');
        };
        
        const showError = (message = 'Erreur de chargement') => {
            const loading = $('loading');
            const error = $('error');
            
            if (loading) loading.style.display = 'none';
            if (error) {
                error.textContent = message;
                error.classList.remove('hidden');
            }
            console.error('❌', message);
        };
        
        const showForm = () => {
            const loading = $('loading');
            const error = $('error');
            const form = $('form');
            
            if (loading) loading.style.display = 'none';
            if (error) error.classList.add('hidden');
            if (form) form.classList.remove('hidden');
        };
        
        // Chargement des données CSV - VERSION SIMPLIFIÉE
        const loadData = async () => {
            try {
                console.log('📡 Chargement CSV depuis:', CONFIG.csvUrl);
                
                const response = await fetch(CONFIG.csvUrl);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const csv = await response.text();
                console.log('📄 CSV reçu, taille:', csv.length, 'caractères');
                
                // Parser le CSV de manière robuste
                const lines = csv.replace(/^\uFEFF/, '').trim().split('\n');
                if (lines.length < 2) {
                    throw new Error('Fichier CSV vide ou invalide');
                }
                
                const headers = lines[0].split(';').map(h => h.trim());
                console.log('📋 En-têtes CSV:', headers);
                
                data = lines.slice(1).map(line => {
                    const values = line.split(';');
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = (values[index] || '').trim();
                    });
                    return row;
                }).filter(row => {
                    // Filtrer les lignes vides
                    return row["Marque"] && row["Série"] && row["Modèle"];
                });
                
                console.log('✅ Données parsées:', data.length, 'lignes valides');
                
                if (data.length === 0) {
                    throw new Error('Aucune donnée valide trouvée dans le CSV');
                }
                
                return true;
            } catch (error) {
                console.error('❌ Erreur chargement CSV:', error);
                throw error;
            }
        };
        
        // VERSION SIMPLE - Pas de filtrage intelligent pour éviter les erreurs
        const createOption = (value, icon, title, subtitle, type) => {
            const div = document.createElement('div');
            div.className = 'option';
            div.setAttribute('data-value', value);
            
            div.innerHTML = `
                <div class="option-icon">${icon}</div>
                <div class="option-title">${title}</div>
                ${subtitle ? `<div class="option-subtitle">${subtitle}</div>` : ''}
            `;
            
            div.onclick = () => selectOption(type, value, div);
            return div;
        };
        
        // Sélection d'option - VERSION SIMPLIFIÉE
        const selectOption = (type, value, element) => {
            console.log(`🎯 Sélection: ${type} = ${value}`);
            
            // Désélectionner les autres
            const container = element.parentElement;
            if (container) {
                container.querySelectorAll('.option').forEach(opt => opt.classList.remove('selected'));
            }
            element.classList.add('selected');
            
            // Sauvegarder
            selections[type] = value;
            
            // Actions spécifiques selon le type
            if (type === 'brand') {
                selections.series = '';
                selections.model = '';
                populateSeries();
            } else if (type === 'series') {
                selections.model = '';
                populateModels();
            } else if (type === 'model') {
                calculatePrice();
                return;
            }
            
            updateSummary();
            
            // Avancer automatiquement
            if (step < 5) {
                setTimeout(() => {
                    step++;
                    showStep(step);
                    updateProgress();
                }, 300);
            }
        };
        
        // Population des options - VERSION SIMPLE
        const populateRepairs = () => {
            const container = $('repairOptions');
            if (!container) return;
            
            container.innerHTML = '';
            
            const repairs = [
                { value: 'Écran', icon: '📱', title: 'Écran', subtitle: 'Réparation d\'écran' },
                { value: 'Batterie', icon: '🔋', title: 'Batterie', subtitle: 'Remplacement' },
                { value: 'Châssis', icon: '🛡️', title: 'Châssis', subtitle: 'Réparation' }
            ];
            
            repairs.forEach(repair => {
                const option = createOption(repair.value, repair.icon, repair.title, repair.subtitle, 'repair');
                container.appendChild(option);
                
                if (selections.repair === repair.value) {
                    option.classList.add('selected');
                }
            });
        };
        
        const populateQualities = () => {
            const container = $('qualityOptions');
            if (!container) return;
            
            container.innerHTML = '';
            
            const qualities = [
                { value: 'Compatible', icon: '💰', title: 'Compatible', subtitle: 'Pièce économique' },
                { value: 'Origine', icon: '✨', title: 'Origine', subtitle: 'Pièce premium' }
            ];
            
            qualities.forEach(quality => {
                const option = createOption(quality.value, quality.icon, quality.title, quality.subtitle, 'quality');
                container.appendChild(option);
                
                if (selections.quality === quality.value) {
                    option.classList.add('selected');
                }
            });
        };
        
        const populateBrands = () => {
            const container = $('brandOptions');
            if (!container || !data.length) return;
            
            container.innerHTML = '';
            
            try {
                const brands = [...new Set(data.map(r => r["Marque"]).filter(Boolean))].sort();
                console.log('🏭 Marques trouvées:', brands.length);
                
                brands.forEach(brand => {
                    const option = createOption(brand, '📱', brand, '', 'brand');
                    container.appendChild(option);
                    
                    if (selections.brand === brand) {
                        option.classList.add('selected');
                    }
                });
            } catch (error) {
                console.error('❌ Erreur population marques:', error);
            }
        };
        
        const populateSeries = () => {
            const container = $('seriesOptions');
            if (!container || !selections.brand || !data.length) return;
            
            container.innerHTML = '';
            
            try {
                const series = [...new Set(data
                    .filter(r => r["Marque"] === selections.brand)
                    .map(r => r["Série"])
                    .filter(Boolean))].sort();
                
                console.log('📋 Séries pour', selections.brand, ':', series.length);
                
                series.forEach(s => {
                    const option = createOption(s, '📋', s, '', 'series');
                    container.appendChild(option);
                    
                    if (selections.series === s) {
                        option.classList.add('selected');
                    }
                });
            } catch (error) {
                console.error('❌ Erreur population séries:', error);
            }
        };
        
        const populateModels = () => {
            const container = $('modelOptions');
            if (!container || !selections.brand || !selections.series || !data.length) return;
            
            container.innerHTML = '';
            
            try {
                const models = [...new Set(data
                    .filter(r => r["Marque"] === selections.brand && r["Série"] === selections.series)
                    .map(r => r["Modèle"])
                    .filter(Boolean))].sort();
                
                console.log('📲 Modèles pour', selections.brand, selections.series, ':', models.length);
                
                models.forEach(m => {
                    const option = createOption(m, '📲', m, '', 'model');
                    container.appendChild(option);
                    
                    if (selections.model === m) {
                        option.classList.add('selected');
                    }
                });
            } catch (error) {
                console.error('❌ Erreur population modèles:', error);
            }
        };
        
        // Gestion des étapes
        const showStep = (stepNumber) => {
            $$('.form-step').forEach(s => s.classList.remove('active'));
            const currentStep = $(`step-${stepNumber}`);
            if (currentStep) currentStep.classList.add('active');
            
            $$('.step').forEach((item, index) => {
                const circle = item.querySelector('.step-circle');
                if (!circle) return;
                
                item.classList.remove('active', 'completed');
                circle.classList.remove('active', 'completed');
                
                if (index + 1 < stepNumber) {
                    item.classList.add('completed');
                    circle.classList.add('completed');
                } else if (index + 1 === stepNumber) {
                    item.classList.add('active');
                    circle.classList.add('active');
                }
            });
        };
        
        const updateProgress = () => {
            const progress = ((step - 1) / 4) * 100;
            const progressLine = $('progressLine');
            if (progressLine) {
                progressLine.style.width = `${progress}%`;
            }
        };
        
        // Résumé
        const updateSummary = () => {
            const content = $('summaryContent');
            if (!content) return;
            
            content.innerHTML = '';
            let hasSelections = false;
            
            const items = [
                { key: 'repair', label: 'Type', value: selections.repair },
                { key: 'quality', label: 'Qualité', value: selections.quality },
                { key: 'brand', label: 'Marque', value: selections.brand },
                { key: 'series', label: 'Série', value: selections.series }
            ];
            
            items.forEach(item => {
                if (item.value) {
                    const div = document.createElement('div');
                    div.className = 'summary-item';
                    div.innerHTML = `<span>${item.label} :</span> <span class="summary-value">${item.value}</span>`;
                    content.appendChild(div);
                    hasSelections = true;
                }
            });
            
            const summary = $('summary');
            if (summary) {
                summary.classList.toggle('visible', hasSelections);
            }
        };
        
        // Calcul du prix
        const calculatePrice = () => {
            const { repair, quality, brand, series, model } = selections;
            
            console.log('💰 Calcul prix pour:', { repair, quality, brand, series, model });
            
            try {
                const row = data.find(r =>
                    r["Marque"] === brand &&
                    r["Série"] === series &&
                    r["Modèle"] === model &&
                    r["Type de réparation"] === repair &&
                    r["Qualité"] === quality
                );
                
                console.log('📄 Ligne trouvée:', row);
                
                if (row) {
                    const priceKey = Object.keys(row).find(key => 
                        key.toLowerCase().includes("prix") && 
                        key.toLowerCase().includes("standard")
                    );
                    const price = row[priceKey];
                    
                    console.log('💰 Prix trouvé:', price, 'pour clé:', priceKey);
                    
                    if (price && price.toString().trim() !== "" && price !== "0") {
                        showPrice(price);
                    } else {
                        showUnavailable();
                    }
                } else {
                    showUnavailable();
                }
            } catch (error) {
                console.error('❌ Erreur calcul prix:', error);
                showUnavailable();
            }
        };
        
        const showPrice = (price) => {
            const priceMain = $('priceMain');
            const repairType = $('repairType');
            const deviceInfo = $('deviceInfo');
            const qualityInfo = $('qualityInfo');
            const timeEstimate = $('timeEstimate');
            const priceResult = $('priceResult');
            const contactSection = $('contactSection');
            
            if (priceMain) {
                priceMain.textContent = `${price} €`;
                priceMain.style.color = ''; // Reset color
            }
            if (repairType) repairType.textContent = selections.repair;
            if (deviceInfo) deviceInfo.textContent = `${selections.brand} ${selections.series} ${selections.model}`;
            if (qualityInfo) qualityInfo.textContent = selections.quality;
            if (timeEstimate) timeEstimate.textContent = CONFIG.repairTimes[selections.repair] || '30-60 min';
            
            if (priceResult) priceResult.style.display = 'block';
            if (contactSection) contactSection.style.display = 'block';
            
            // Masquer les étapes
            $$('.form-step').forEach(s => s.style.display = 'none');
        };
        
        const showUnavailable = () => {
            const priceMain = $('priceMain');
            if (priceMain) {
                priceMain.textContent = 'Non disponible';
                priceMain.style.color = '#dc3545';
            }
            showPrice('0');
        };
        
        // Fonctions globales
        window.goToStep = (targetStep) => {
            if (targetStep <= step) {
                const priceResult = $('priceResult');
                const contactSection = $('contactSection');
                
                if (priceResult) priceResult.style.display = 'none';
                if (contactSection) contactSection.style.display = 'none';
                
                $$('.form-step').forEach(s => s.style.display = 'block');
                step = targetStep;
                showStep(step);
                updateProgress();
            }
        };
        
        window.resetForm = () => {
            selections = {};
            step = 1;
            
            const priceResult = $('priceResult');
            const contactSection = $('contactSection');
            const summary = $('summary');
            
            if (priceResult) priceResult.style.display = 'none';
            if (contactSection) contactSection.style.display = 'none';
            if (summary) summary.classList.remove('visible');
            
            $$('.form-step').forEach(s => {
                s.style.display = 'block';
                s.classList.remove('active');
            });
            
            $$('.option.selected').forEach(opt => opt.classList.remove('selected'));
            
            const seriesOptions = $('seriesOptions');
            const modelOptions = $('modelOptions');
            if (seriesOptions) seriesOptions.innerHTML = '';
            if (modelOptions) modelOptions.innerHTML = '';
            
            // Repeupler les options de base
            populateRepairs();
            populateQualities();
            populateBrands();
            
            showStep(1);
            updateProgress();
        };
        
        window.handleContact = () => {
            // Sauvegarder les données pour la page RDV
            const appointmentData = {
                userSelections: selections,
                priceInfo: {
                    price: $('priceMain') ? $('priceMain').textContent : '',
                    duration: $('timeEstimate') ? $('timeEstimate').textContent : ''
                },
                timestamp: new Date().toISOString()
            };
            
            try {
                localStorage.setItem('latelier_appointment_data', JSON.stringify(appointmentData));
            } catch (e) {
                console.warn('⚠️ Impossible de sauvegarder dans localStorage:', e);
            }
            
            // Redirection vers la page RDV
            if (CONFIG.odooConfig && CONFIG.odooConfig.appointmentUrl) {
                window.location.href = CONFIG.odooConfig.appointmentUrl;
            } else {
                alert('URL de rendez-vous non configurée');
            }
        };
        
        // Initialisation principale
        const init = async () => {
            try {
                showLoading();
                console.log('🚀 Démarrage de l\'initialisation...');
                
                await loadData();
                
                // Peupler les options de base
                populateRepairs();
                populateQualities();
                populateBrands();
                
                showForm();
                showStep(1);
                updateProgress();
                
                console.log('✅ Configurateur GitHub initialisé avec succès');
                
            } catch (error) {
                console.error('❌ Erreur d\'initialisation:', error);
                showError(`Impossible de charger les données: ${error.message}`);
            }
        };
        
        // Démarrage
        init();
    }
    
})();
